name: Certify Verification Results

on:
  push:
    branches:
      - main
      - la/try_cert
    paths:
      - '.github/workflows/certify-verification.yml'  # For testing, remove after merge
      - 'curve25519-dalek/src/**/*.rs'
      - 'curve25519-dalek/build.rs'
  workflow_dispatch:

permissions:
  contents: write  # Needed to commit certifications.json updates


jobs:
  verify-and-certify:
    name: Run Verification & Certify On-Chain
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout dalek repository
        uses: actions/checkout@v4
        with:
          path: dalek

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.0

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-certify-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-certify-
            ${{ runner.os }}-cargo-

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install verus-analyzer
        run: |
          VERUS_URL=$(curl -s https://api.github.com/repos/verus-lang/verus-analyzer/releases/latest | jq -r '.assets[] | select(.name == "verus-analyzer-x86_64-unknown-linux-gnu.gz") | .browser_download_url')
          wget "$VERUS_URL" -O verus-analyzer.gz
          gunzip verus-analyzer.gz
          chmod +x verus-analyzer
          sudo mv verus-analyzer /usr/local/bin/
          verus-analyzer --version

      - name: Install Verus
        run: |
          # Use specific Verus version compatible with Rust 1.91.0
          # Same as dalek-lite CI: https://github.com/Beneficial-AI-Foundation/dalek-lite/blob/main/.github/workflows/ci.yml
          if [ -x ~/.cargo/bin/verus-x86-linux/verus ]; then
            echo "Verus already installed (from cache)"
          else
            wget https://github.com/verus-lang/verus/releases/download/release%2F0.2025.11.23.41c5885/verus-0.2025.11.23.41c5885-x86-linux.zip
            unzip verus-0.2025.11.23.41c5885-x86-linux.zip
            rm -rf ~/.cargo/bin/verus-x86-linux
            mv verus-x86-linux ~/.cargo/bin
            cd ~/.cargo/bin
            ln -sf verus-x86-linux/cargo-verus
            echo "Verus installed"
          fi

      - name: Install scip CLI
        run: |
          SCIP_URL=$(curl -s https://api.github.com/repos/sourcegraph/scip/releases/latest | jq -r '.assets[] | select(.name == "scip-linux-amd64.tar.gz") | .browser_download_url')
          wget "$SCIP_URL" -O scip-linux.tar.gz
          tar -xzf scip-linux.tar.gz
          chmod +x scip
          sudo mv scip /usr/local/bin/
          scip --version

      - name: Install probe-verus
        run: |
          cargo install --force --git https://github.com/Beneficial-AI-Foundation/probe-verus

      - name: Run probe-verus verify
        id: verify
        working-directory: dalek
        run: |
          # Run verification and generate JSON results
          probe-verus verify ./curve25519-dalek \
            -p curve25519-dalek \
            -o results.json \
            -a
          
          # Output file path for later steps
          echo "results_file=$PWD/results.json" >> $GITHUB_OUTPUT
          
          # Show summary
          echo "=== Verification Results Summary ==="
          cat results.json | jq '.summary'

      - name: Upload verification results artifact
        uses: actions/upload-artifact@v4
        with:
          name: verification-results
          path: dalek/results.json
          retention-days: 90

      # --- Certification Setup ---
      
      - name: Checkout eth_certify
        uses: actions/checkout@v4
        with:
          repository: Beneficial-AI-Foundation/eth_certify
          token: ${{ secrets.CERTIFY_REPO_PAT }}
          path: certify
          submodules: recursive

      - name: Install Python and uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Install certify dependencies
        working-directory: certify
        run: |
          uv sync

      - name: Create certify.conf for verification results
        working-directory: certify
        env:
          RESULTS_FILE: ${{ steps.verify.outputs.results_file }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Configure to certify the local verification results file
          echo "# Auto-generated for CI certification" > certify.conf
          echo "CERTIFY_SOURCE=\"${RESULTS_FILE}\"" >> certify.conf
          echo "CERTIFY_DESCRIPTION=\"Dalek-Lite Verus Verification Results - Commit ${COMMIT_SHA}\"" >> certify.conf
          
          echo "=== certify.conf ==="
          cat certify.conf

      # --- Certification to Ethereum Mainnet via Gnosis Safe ---

      - name: Certify verification results on Mainnet (via Safe)
        id: certify_mainnet
        working-directory: certify
        env:
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}
          MAINNET_PRIVATE_KEY: ${{ secrets.MAINNET_PRIVATE_KEY }}
          CERTIFY_ADDRESS: ${{ vars.MAINNET_CERTIFIER_ADDRESS }}
        run: |
          echo "Certifying verification results hash on Ethereum Mainnet via Gnosis Safe..."
          OUTPUT=$(uv run python3 -m certify_cli certify \
            --network mainnet \
            --safe ${{ vars.MAINNET_SAFE_ADDRESS }} \
            --execute 2>&1) || true
          echo "$OUTPUT"
          
          # Extract transaction hash from output
          TX_HASH=$(echo "$OUTPUT" | grep -oP 'Tx Hash:\s*\K[a-fA-F0-9]+' | head -1)
          CONTENT_HASH=$(echo "$OUTPUT" | grep -oP 'Content Hash:\s*\K0x[a-fA-F0-9]+' | head -1)
          
          if [ -n "$TX_HASH" ]; then
            echo "mainnet_tx_hash=0x${TX_HASH}" >> $GITHUB_OUTPUT
            echo "mainnet_etherscan_url=https://etherscan.io/tx/0x${TX_HASH}" >> $GITHUB_OUTPUT
            echo "✅ Captured Mainnet Tx Hash: 0x${TX_HASH}"
          else
            echo "mainnet_tx_hash=" >> $GITHUB_OUTPUT
            echo "mainnet_etherscan_url=" >> $GITHUB_OUTPUT
            echo "⚠️ Could not extract transaction hash from output"
          fi
          
          if [ -n "$CONTENT_HASH" ]; then
            echo "content_hash=${CONTENT_HASH}" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "✅ Verification results certified on Ethereum Mainnet!"
          echo "View events: https://etherscan.io/address/${{ vars.MAINNET_CERTIFIER_ADDRESS }}#events"

      # --- Certification to Sepolia (Testnet) ---

      - name: Certify verification results on Sepolia
        id: certify_sepolia
        working-directory: certify
        env:
          SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
          SEPOLIA_PRIVATE_KEY: ${{ secrets.CERTIFY_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          CERTIFY_ADDRESS: ${{ vars.SEPOLIA_CERTIFIER_ADDRESS }}
        run: |
          echo "Certifying verification results hash on Sepolia testnet..."
          OUTPUT=$(uv run python3 -m certify_cli certify --network sepolia 2>&1) || true
          echo "$OUTPUT"
          
          # Extract transaction hash from output
          TX_HASH=$(echo "$OUTPUT" | grep -oP 'Tx Hash:\s*\K[a-fA-F0-9]+' | head -1)
          
          if [ -n "$TX_HASH" ]; then
            echo "sepolia_tx_hash=0x${TX_HASH}" >> $GITHUB_OUTPUT
            echo "sepolia_etherscan_url=https://sepolia.etherscan.io/tx/0x${TX_HASH}" >> $GITHUB_OUTPUT
            echo "✅ Captured Sepolia Tx Hash: 0x${TX_HASH}"
          else
            echo "sepolia_tx_hash=" >> $GITHUB_OUTPUT
            echo "sepolia_etherscan_url=" >> $GITHUB_OUTPUT
            echo "⚠️ Could not extract transaction hash from output"
          fi
          
          echo ""
          echo "✅ Verification results certified on Sepolia!"
          echo "View events: https://sepolia.etherscan.io/address/${{ vars.SEPOLIA_CERTIFIER_ADDRESS }}#events"

      # --- Update Certifications History ---

      - name: Update certifications.json
        working-directory: dalek
        env:
          MAINNET_TX_HASH: ${{ steps.certify_mainnet.outputs.mainnet_tx_hash }}
          MAINNET_ETHERSCAN_URL: ${{ steps.certify_mainnet.outputs.mainnet_etherscan_url }}
          SEPOLIA_TX_HASH: ${{ steps.certify_sepolia.outputs.sepolia_tx_hash }}
          SEPOLIA_ETHERSCAN_URL: ${{ steps.certify_sepolia.outputs.sepolia_etherscan_url }}
          CONTENT_HASH: ${{ steps.certify_mainnet.outputs.content_hash }}
          RESULTS_FILE: ${{ steps.verify.outputs.results_file }}
        run: |
          # Build artifact URL
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Get verification summary from results.json
          VERIFIED_COUNT=$(cat "$RESULTS_FILE" | jq -r '.summary.verified // 0')
          TOTAL_FUNCTIONS=$(cat "$RESULTS_FILE" | jq -r '.summary.total // 0')
          
          # Create new certification entry
          NEW_ENTRY=$(jq -n \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg commit_sha "${{ github.sha }}" \
            --arg commit_short "$(echo '${{ github.sha }}' | cut -c1-7)" \
            --arg artifact_url "$ARTIFACT_URL" \
            --arg content_hash "${CONTENT_HASH:-}" \
            --arg mainnet_tx "${MAINNET_TX_HASH:-}" \
            --arg mainnet_etherscan "${MAINNET_ETHERSCAN_URL:-}" \
            --arg sepolia_tx "${SEPOLIA_TX_HASH:-}" \
            --arg sepolia_etherscan "${SEPOLIA_ETHERSCAN_URL:-}" \
            --argjson verified_count "${VERIFIED_COUNT:-0}" \
            --argjson total_functions "${TOTAL_FUNCTIONS:-0}" \
            '{
              timestamp: $timestamp,
              commit_sha: $commit_sha,
              commit_short: $commit_short,
              artifact_url: $artifact_url,
              content_hash: $content_hash,
              mainnet_tx: $mainnet_tx,
              mainnet_etherscan: $mainnet_etherscan,
              sepolia_tx: $sepolia_tx,
              sepolia_etherscan: $sepolia_etherscan,
              verified_count: $verified_count,
              total_functions: $total_functions
            }')
          
          # Update or create certifications.json
          CERT_FILE="docs/certifications.json"
          if [ -f "$CERT_FILE" ]; then
            # Prepend new entry to existing certifications array
            jq --argjson new "$NEW_ENTRY" '.certifications = [$new] + .certifications' "$CERT_FILE" > tmp.json
            mv tmp.json "$CERT_FILE"
          else
            # Create new file with initial entry
            mkdir -p docs
            jq -n --argjson entry "$NEW_ENTRY" '{ certifications: [$entry] }' > "$CERT_FILE"
          fi
          
          echo "=== Updated certifications.json ==="
          cat "$CERT_FILE" | jq '.'

      - name: Commit certifications.json
        working-directory: dalek
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/certifications.json
          
          if git diff --cached --quiet; then
            echo "No changes to certifications.json"
          else
            git commit -m "chore: update certifications.json with tx ${{ steps.certify_mainnet.outputs.mainnet_tx_hash }}"
            git push
            echo "✅ Committed and pushed certifications.json update"
          fi

