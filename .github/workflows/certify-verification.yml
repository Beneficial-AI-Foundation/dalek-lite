name: Certify Verification Results

on:
  push:
    branches:
      - main
    paths:
      - 'curve25519-dalek/src/**/*.rs'
      - 'curve25519-dalek/build.rs'
  workflow_dispatch:

permissions:
  contents: write  # Needed to commit certifications.json updates

jobs:
  verify-and-certify:
    name: Run Verification & Certify On-Chain
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ═══════════════════════════════════════════════════════════════
      # STEP 1: Run Verus Verification
      # ═══════════════════════════════════════════════════════════════
      - name: Run Verus verification
        uses: Beneficial-AI-Foundation/probe-verus/action@main
        id: verify
        with:
          project-path: ./curve25519-dalek
          package: curve25519-dalek
          output-dir: ./output

      - name: Verification summary
        run: |
          echo "## Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Verified**: ${{ steps.verify.outputs.verified-count }} / ${{ steps.verify.outputs.total-functions }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload verification results artifact
        uses: actions/upload-artifact@v4
        with:
          name: verification-results
          path: ./output/results.json
          retention-days: 90

      # ═══════════════════════════════════════════════════════════════
      # STEP 2: Certify on Ethereum Mainnet (via Gnosis Safe)
      # ═══════════════════════════════════════════════════════════════
      - name: Certify on Mainnet
        id: certify_mainnet
        uses: Beneficial-AI-Foundation/eth_certify/action@main
        continue-on-error: true
        with:
          source: ${{ steps.verify.outputs.results-file }}
          description: "Dalek-Lite Verus Verification - Commit ${{ github.sha }}"
          network: mainnet
          rpc-url: ${{ secrets.MAINNET_RPC_URL }}
          private-key: ${{ secrets.MAINNET_PRIVATE_KEY }}
          certify-address: ${{ vars.MAINNET_CERTIFIER_ADDRESS }}
          safe-address: ${{ vars.MAINNET_SAFE_ADDRESS }}
          safe-execute: 'true'

      # ═══════════════════════════════════════════════════════════════
      # STEP 3: Certify on Sepolia (Testnet)
      # ═══════════════════════════════════════════════════════════════
      - name: Certify on Sepolia
        id: certify_sepolia
        uses: Beneficial-AI-Foundation/eth_certify/action@main
        continue-on-error: true
        with:
          source: ${{ steps.verify.outputs.results-file }}
          description: "Dalek-Lite Verus Verification - Commit ${{ github.sha }}"
          network: sepolia
          rpc-url: ${{ secrets.SEPOLIA_RPC_URL }}
          private-key: ${{ secrets.SEPOLIA_PRIVATE_KEY }}
          certify-address: ${{ vars.SEPOLIA_CERTIFIER_ADDRESS }}
          etherscan-api-key: ${{ secrets.ETHERSCAN_API_KEY }}

      # ═══════════════════════════════════════════════════════════════
      # STEP 4: Validate & Update Certifications History
      # ═══════════════════════════════════════════════════════════════
      - name: Validate at least one certification succeeded
        env:
          MAINNET_TX_HASH: ${{ steps.certify_mainnet.outputs.tx-hash }}
          SEPOLIA_TX_HASH: ${{ steps.certify_sepolia.outputs.tx-hash }}
        run: |
          echo "=== Certification Results ==="
          echo "Mainnet TX: ${MAINNET_TX_HASH:-'(none)'}"
          echo "Sepolia TX: ${SEPOLIA_TX_HASH:-'(none)'}"
          
          if [ -z "$MAINNET_TX_HASH" ] && [ -z "$SEPOLIA_TX_HASH" ]; then
            echo ""
            echo "::error::Both Mainnet and Sepolia certifications failed. No transaction hashes captured."
            exit 1
          fi
          
          echo ""
          echo "✅ At least one certification succeeded"

      - name: Update certifications.json
        env:
          MAINNET_TX_HASH: ${{ steps.certify_mainnet.outputs.tx-hash }}
          MAINNET_ETHERSCAN_URL: ${{ steps.certify_mainnet.outputs.etherscan-url }}
          MAINNET_CONTENT_HASH: ${{ steps.certify_mainnet.outputs.content-hash }}
          SEPOLIA_TX_HASH: ${{ steps.certify_sepolia.outputs.tx-hash }}
          SEPOLIA_ETHERSCAN_URL: ${{ steps.certify_sepolia.outputs.etherscan-url }}
          SEPOLIA_CONTENT_HASH: ${{ steps.certify_sepolia.outputs.content-hash }}
          VERIFIED_COUNT: ${{ steps.verify.outputs.verified-count }}
          TOTAL_FUNCTIONS: ${{ steps.verify.outputs.total-functions }}
        run: |
          # Build artifact URL
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Use Mainnet content hash if available, otherwise fall back to Sepolia
          CONTENT_HASH="${MAINNET_CONTENT_HASH:-$SEPOLIA_CONTENT_HASH}"
          
          # Create new certification entry
          NEW_ENTRY=$(jq -n \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg commit_sha "${{ github.sha }}" \
            --arg commit_short "$(echo '${{ github.sha }}' | cut -c1-7)" \
            --arg artifact_url "$ARTIFACT_URL" \
            --arg content_hash "${CONTENT_HASH:-}" \
            --arg mainnet_tx "${MAINNET_TX_HASH:-}" \
            --arg mainnet_etherscan "${MAINNET_ETHERSCAN_URL:-}" \
            --arg sepolia_tx "${SEPOLIA_TX_HASH:-}" \
            --arg sepolia_etherscan "${SEPOLIA_ETHERSCAN_URL:-}" \
            --argjson verified_count "${VERIFIED_COUNT:-0}" \
            --argjson total_functions "${TOTAL_FUNCTIONS:-0}" \
            '{
              timestamp: $timestamp,
              commit_sha: $commit_sha,
              commit_short: $commit_short,
              artifact_url: $artifact_url,
              content_hash: $content_hash,
              mainnet_tx: $mainnet_tx,
              mainnet_etherscan: $mainnet_etherscan,
              sepolia_tx: $sepolia_tx,
              sepolia_etherscan: $sepolia_etherscan,
              verified_count: $verified_count,
              total_functions: $total_functions
            }')
          
          # Update or create certifications.json
          CERT_FILE="docs/certifications.json"
          if [ -f "$CERT_FILE" ]; then
            jq --argjson new "$NEW_ENTRY" '.certifications = [$new] + .certifications' "$CERT_FILE" > tmp.json
            mv tmp.json "$CERT_FILE"
          else
            mkdir -p docs
            jq -n --argjson entry "$NEW_ENTRY" '{ certifications: [$entry] }' > "$CERT_FILE"
          fi
          
          echo "=== Updated certifications.json ==="
          cat "$CERT_FILE" | jq '.'

      - name: Commit certifications.json
        env:
          MAINNET_TX_HASH: ${{ steps.certify_mainnet.outputs.tx-hash }}
          SEPOLIA_TX_HASH: ${{ steps.certify_sepolia.outputs.tx-hash }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docs/certifications.json
          
          if git diff --cached --quiet; then
            echo "::error::No changes to certifications.json despite successful certification."
            exit 1
          fi
          
          TX_REF="${MAINNET_TX_HASH:-$SEPOLIA_TX_HASH}"
          git commit -m "chore: update certifications.json with tx ${TX_REF}"
          git push
          echo "✅ Committed and pushed certifications.json update"

      - name: Final summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Certification Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.certify_mainnet.outputs.tx-hash }}" ]; then
            echo "**Mainnet**: [${{ steps.certify_mainnet.outputs.tx-hash }}](${{ steps.certify_mainnet.outputs.etherscan-url }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.certify_sepolia.outputs.tx-hash }}" ]; then
            echo "**Sepolia**: [${{ steps.certify_sepolia.outputs.tx-hash }}](${{ steps.certify_sepolia.outputs.etherscan-url }})" >> $GITHUB_STEP_SUMMARY
          fi
